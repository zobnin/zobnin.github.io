<p>
Я <a href="http://androidstreet.net/2013/12/12/build-aosp/">уже рассказывал</a> как самостоятельно собрать Android из исходных текстов. В той заметке речь шла об AOSP, то есть официальной версии Android, распространяемой Google. К сожаления, используя исходники AOSP можно собрать только прошивики для устройств линейки Nexus, поэтому сегодня я расскажу как собрать свою собственную версию CyanogenMod для одного из сотен поддерживаемых устройств.
</p>

::cut::

<h3>Официальный и неофициальный CyanogenMod</h3>
<p>
Перед тем как перейти к рассказу о сборке сразу предупрежу, что порт CyanogenMod на устройство бывает официальный и неофициальный. Различаются они в первую очередь тем, что в случае официальных портов в команде CyanogenMod есть человек, который следит за тем, чтобы новые версии прошивки работали на нужных устройствах. Для каждого устройства в исходниках CyanogenMod есть собственное "дерево устройства", которое как раз и содержит все специфичные для конкретного смартфона/планшета файлы.
</p><p>
Для неофициальных портов "дерево устройства" в исходниках CyanogenMod не предусмотрено, поэтому в случае сборки прошивки для неподдерживаемого официально устройства это самое дерево придется найти самостоятельно. В первую очередь следует спросить у того, кто уже выполнил порт прошивки на нужный девайс или просто поискать на github.com.
</p><p>
В этой статье я расскажу как собрать CyanogenMod для официально поддерживаемого Nexus 4, а также как собрать неофициальный порт прошивки для Motorola Defy.
</p>
<h3>Подготовка и получение исходных текстов</h3>
<p>
Подготовка к сборке и процесс получения исходных текстов не сильно отличаются от случая с AOSP и будут одинаковыми для обоих устройств (Nexus 4 или Defy). Сначала устанавливаем необходимые для сборки пакеты (не забываем, что делать это нужно в 64-битной Ubuntu):
<pre>
$ sudo apt-get install \
git-core gnupg flex bison gperf libsdl1.2-dev libesd0-dev \
libwxgtk2.8-dev squashfs-tools build-essential zip curl \
libncurses5-dev zlib1g-dev openjdk-6-jre openjdk-6-jdk \
pngcrush schedtool libxml2 libxml2-utils xsltproc \
g++-multilib lib32z1-dev lib32ncurses5-dev lib32readline-gplv2-dev gcc-multilib
</pre>
</p><p>
Скачиваем инструмент repo, представляющий собой python-обертку вокруг системы контроля версий git:
<pre>
$ mkdir ~/bin
$ curl https://dl-ssl.google.com/dl/googlesource/git-repo/repo > ~/bin/repo
$ chmod a+x ~/bin/repo
$ export PATH=$PATH:~/bin
</pre>
</p><p>
Далее загружаем исходные тексты нужной версии CyanogenMod (в данном случае cm-11):
<pre>
$ mkdir -p android/cm
$ cd android/cm
$ repo init \
   -u git://github.com/CyanogenMod/android -b cm-11 \ 
$ repo sync
</pre>
</p><p>
Также нам понадобятся различные бинарные файлы для разных устройств, которые не входят в состав исходников. Чтобы их получить выполняем две команды:
<pre>
$ cd vendor/cm
$ ./get-prebuilds
$ cd -
</pre>
</p>
<h3>Сборка CyanogenMod для Nexus 4</h3>
<p>
Чтобы получить нужное нам дерево устройства выполняем следующую команду (mako - это кодовове имя Nexus 4):
<pre>
$ source build/envsetup.sh
$ breakfast mako
</pre>
</p><p>
Далее необходимо подключить смартфон к ПК и получить с него проприетарные файлы, которые будут использованы в прошивке. Для этого необходимо сначала установить adb:
<pre>
$ sudo apt-get install android-tools-fastboot
</pre>
А затем выполнить следующую команду:
<pre>
$ cd device/lge/mako
$ ./extract-files.sh
$ cd -
</pre>
</p><p>
Если все прошло гладко можно запускать процесс сборки:
<pre>
$ croot
$ brunch mako
</pre>
После окончания сборки в каталоге out/target/product/mako/ появится файл с именем вроде cm-11-XXXXXXXXX-UNOFFICIAL-mako.zip. Это и есть наша прошивка, которую можно установить с помощью консоли восстановления (recovery). О том как это сделать я <a href="http://androidstreet.net/2013/05/04/recovery/">уже писал</a>.
</p>
<h3>Сборка CyanogenMod для Motorola Defy</h3>
<p>
Как я уже говорил, для того, чтобы собрать прошивку для неофициально-поддерживаемого смартфона/планшета кроме исходных текстов CyanogenMod понадобится тоже "дерево устройства", которое должно располагаться в каталоге "device/производитель/имя_устройства". Поэтому дерево устройства для нужного нам гаджета мы должны найти самостоятельно, затем положить его в каталог исходников CyanogenMod и выполнить процесс сборки как описано в предыдущем разделе (заменив mako на нужное имя устройства и опустив первые две команды).
</p><p>
В случае с Motorola Defy все еще проще. Полные исходные тексты cm-11 вместе с деревом устройства для этого смартфона есть в репозитории Quarx, так что их можно собрать также как официально поддерживаемый CyanogenMod:
<pre>
$ mkdir cm-11-defy; cd cm-11-defy
$ repo init -u git://github.com/Quarx2k/android.git \
     -b cm-11
$ repo sync
$ ~/android/system/vendor/cm/get-prebuilds
$ source build/envsetup.sh
$ brunch mb526
</pre>
Результат появится в out/target/product/mb526/
</p>


